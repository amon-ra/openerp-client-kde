<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Koo API documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>FullTextSearchDialog.py</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">##############################################################################</span>
<a name="l00002"></a>00002 <span class="comment">#</span>
<a name="l00003"></a>00003 <span class="comment"># Copyright (c) 2004 TINY SPRL. (http://tiny.be) All Rights Reserved.</span>
<a name="l00004"></a>00004 <span class="comment">#                                       Fabien Pinckaers &lt;fp@tiny.Be&gt;</span>
<a name="l00005"></a>00005 <span class="comment"># Copyright (c) 2007-2008 Albert Cervera i Areny &lt;albert@nan-tic.com&gt;</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment"># WARNING: This program as such is intended to be used by professional</span>
<a name="l00008"></a>00008 <span class="comment"># programmers who take the whole responsability of assessing all potential</span>
<a name="l00009"></a>00009 <span class="comment"># consequences resulting from its eventual inadequacies and bugs</span>
<a name="l00010"></a>00010 <span class="comment"># End users who are looking for a ready-to-use solution with commercial</span>
<a name="l00011"></a>00011 <span class="comment"># garantees and support are strongly adviced to contract a Free Software</span>
<a name="l00012"></a>00012 <span class="comment"># Service Company</span>
<a name="l00013"></a>00013 <span class="comment">#</span>
<a name="l00014"></a>00014 <span class="comment"># This program is Free Software; you can redistribute it and/or</span>
<a name="l00015"></a>00015 <span class="comment"># modify it under the terms of the GNU General Public License</span>
<a name="l00016"></a>00016 <span class="comment"># as published by the Free Software Foundation; either version 2</span>
<a name="l00017"></a>00017 <span class="comment"># of the License, or (at your option) any later version.</span>
<a name="l00018"></a>00018 <span class="comment">#</span>
<a name="l00019"></a>00019 <span class="comment"># This program is distributed in the hope that it will be useful,</span>
<a name="l00020"></a>00020 <span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00021"></a>00021 <span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00022"></a>00022 <span class="comment"># GNU General Public License for more details.</span>
<a name="l00023"></a>00023 <span class="comment">#</span>
<a name="l00024"></a>00024 <span class="comment"># You should have received a copy of the GNU General Public License</span>
<a name="l00025"></a>00025 <span class="comment"># along with this program; if not, write to the Free Software</span>
<a name="l00026"></a>00026 <span class="comment"># Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00027"></a>00027 <span class="comment">#</span>
<a name="l00028"></a>00028 <span class="comment">##############################################################################</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">import</span> gettext
<a name="l00031"></a>00031 <span class="keyword">from</span> Koo.Common <span class="keyword">import</span> Common
<a name="l00032"></a>00032 <span class="keyword">from</span> Koo.Common <span class="keyword">import</span> Numeric
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="keyword">from</span> Koo <span class="keyword">import</span> Rpc
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">from</span> PyQt4.QtGui <span class="keyword">import</span> *
<a name="l00037"></a>00037 <span class="keyword">from</span> PyQt4.QtCore <span class="keyword">import</span> *
<a name="l00038"></a>00038 <span class="keyword">from</span> PyQt4.uic <span class="keyword">import</span> *
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="keyword">class </span>SearchViewItem( QWidget ):
<a name="l00041"></a>00041         <span class="keyword">def </span>__init__( self, uiFile, parent = None ):
<a name="l00042"></a>00042                 QWidget.__init__( self, parent )
<a name="l00043"></a>00043                 loadUi( uiFile, self )
<a name="l00044"></a>00044                 self.index = <span class="keywordtype">None</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">## @brief The SearchView class provides a view for a list of custom widgets.</span>
<a name="l00047"></a>00047 <span class="comment">#</span>
<a name="l00048"></a>00048 <span class="comment"># SearchView, simplifies the task of creating a list-like view for a model</span>
<a name="l00049"></a>00049 <span class="comment"># in which the items of the list are custom widgets. Even more, SearchView</span>
<a name="l00050"></a>00050 <span class="comment"># allows to trivially use a '.ui' to be used as items, where you only need</span>
<a name="l00051"></a>00051 <span class="comment"># to map model indexes into .ui widget names.</span>
<a name="l00052"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html">00052</a> <span class="keyword">class </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html" title="The SearchView class provides a view for a list of custom widgets.">SearchView</a>( QAbstractItemView ):
<a name="l00053"></a>00053         <span class="keyword">def </span>__init__( self, parent = None ):
<a name="l00054"></a>00054                 QAbstractItemView.__init__( self, parent )
<a name="l00055"></a>00055                 self.setViewport( QWidget(self) )
<a name="l00056"></a>00056                 layout = QVBoxLayout( self.viewport() )
<a name="l00057"></a>00057                 layout.setSpacing( 0 )
<a name="l00058"></a>00058                 layout.setMargin( 0 )
<a name="l00059"></a>00059                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#148bacc89eef3f3a8be9a5dc75993d4c">items</a> = []
<a name="l00060"></a>00060                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#e6ba6584be6c5b5ce409c4dfd49ae818">selected</a> = -1
<a name="l00061"></a>00061                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#2655c7ac6bcb081da8d355b536796b0a">keyboard</a> = <span class="stringliteral">""</span>
<a name="l00062"></a>00062                 self.setVerticalScrollBarPolicy( Qt.ScrollBarAlwaysOn )
<a name="l00063"></a>00063                 self.connect( self.verticalScrollBar(), SIGNAL(<span class="stringliteral">'valueChanged(int)'</span>), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#4a54cb6bd4ece79d73781780cc56417a">scrollBarChanged</a> )
<a name="l00064"></a>00064                 self.setEditTriggers( QAbstractItemView.NoEditTriggers )
<a name="l00065"></a>00065 
<a name="l00066"></a>00066         <span class="keyword">def </span>scrollBarChanged(self, value):
<a name="l00067"></a>00067                 self.viewport().move( 0, - value )
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <span class="comment">## @brief Map the label or widget of each item with </span>
<a name="l00070"></a>00070         <span class="comment"># the corresponding column of the model</span>
<a name="l00071"></a>00071         <span class="comment">#</span>
<a name="l00072"></a>00072         <span class="comment"># Example of a valid map:</span>
<a name="l00073"></a>00073         <span class="comment"># \code</span>
<a name="l00074"></a>00074         <span class="comment">#  map = [ ('uiModel', 3), ('uiName', 4), ('uiHeadline', 5), ('uiRanking', 6) ]</span>
<a name="l00075"></a>00075         <span class="comment">#  uiItems.setModelItemMap( map )</span>
<a name="l00076"></a>00076         <span class="comment"># \endcode</span>
<a name="l00077"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#db635e5f8963b65e9c4596cb829e4ffc">00077</a>         <span class="keyword">def </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#db635e5f8963b65e9c4596cb829e4ffc" title="Map the label or widget of each item with the corresponding column of the model.">setModelItemMap</a>(self, map):
<a name="l00078"></a>00078                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#9802ce8acbab25e482e6784c8f616399">map</a> = map
<a name="l00079"></a>00079 
<a name="l00080"></a>00080         <span class="comment">## @brief Sets the .ui file that will be used to represent each item</span>
<a name="l00081"></a>00081         <span class="comment">#  int the list</span>
<a name="l00082"></a>00082         <span class="comment">#</span>
<a name="l00083"></a>00083         <span class="comment"># The .ui file should contain QLabels which will be mapped using</span>
<a name="l00084"></a>00084         <span class="comment"># setModelItemMap().</span>
<a name="l00085"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#db6ecf82d725f120f13637992bf712fe">00085</a>         <span class="keyword">def </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#db6ecf82d725f120f13637992bf712fe" title="Sets the .ui file that will be used to represent each item int the list.">setItemUi</a>(self, uiFile ):
<a name="l00086"></a>00086                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#392ccac6d3cc215f873887a63a00a309">uiFile</a> = uiFile
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         <span class="comment">## @brief You may inherit this class and reimplement this function if your items,</span>
<a name="l00089"></a>00089         <span class="comment"># aren't created from ui files or the file is not composed</span>
<a name="l00090"></a>00090         <span class="comment"># only of simple labels.</span>
<a name="l00091"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#e32fd29c2108bbdf55014f595dc54756">00091</a>         <span class="keyword">def </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#e32fd29c2108bbdf55014f595dc54756" title="You may inherit this class and reimplement this function if your items, aren&amp;#39;t...">createItemWidget</a>(self, parent):
<a name="l00092"></a>00092                 <span class="keywordflow">return</span> SearchViewItem( self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#392ccac6d3cc215f873887a63a00a309">uiFile</a>, parent )
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         <span class="comment">## @brief Reimplement this function if you don't use the map to automatically</span>
<a name="l00095"></a>00095         <span class="comment"># fill the item widget. Note that the index of the model is inside </span>
<a name="l00096"></a>00096         <span class="comment"># 'item.index'.</span>
<a name="l00097"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#66c5514ca5e350288b30ce49784f3711">00097</a>         <span class="keyword">def </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1SearchView.html#66c5514ca5e350288b30ce49784f3711" title="Reimplement this function if you don&amp;#39;t use the map to automatically fill the...">fillItemWidget</a>( self, item ):
<a name="l00098"></a>00098                 <span class="keywordflow">pass</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100         <span class="comment"># Functions required by QAbstractItemView</span>
<a name="l00101"></a>00101         <span class="keyword">def </span>indexAt( self, point ):
<a name="l00102"></a>00102                 idx = QModelIndex()
<a name="l00103"></a>00103                 y = 0
<a name="l00104"></a>00104                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00105"></a>00105                         <span class="keywordflow">if</span> x.geometry().contains(point):
<a name="l00106"></a>00106                                 <span class="keywordflow">return</span> x.index
<a name="l00107"></a>00107                         y += 1
<a name="l00108"></a>00108                 <span class="keywordflow">return</span> idx
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="keyword">def </span>keyboardSearch( self, search ):
<a name="l00111"></a>00111                 search = self.keyboard + unicode(search).lower()
<a name="l00112"></a>00112                 found = <span class="keyword">False</span>
<a name="l00113"></a>00113                 start = max(self.selected, 0)
<a name="l00114"></a>00114                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> range(start, len(self.items)):
<a name="l00115"></a>00115                         <span class="keywordflow">if</span> unicode(self.items[x].uiName.text()).lower().startswith( search ):
<a name="l00116"></a>00116                                 found = <span class="keyword">True</span>
<a name="l00117"></a>00117                                 <span class="keywordflow">break</span>
<a name="l00118"></a>00118                 <span class="keywordflow">if</span> found:
<a name="l00119"></a>00119                         self.selected = x
<a name="l00120"></a>00120                         self.keyboard = search
<a name="l00121"></a>00121                         self.highlightSelected()
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keyword">def </span>scrollTo( self, index, hint ): 
<a name="l00124"></a>00124                 pos = <span class="keywordtype">None</span>
<a name="l00125"></a>00125                 <span class="keywordflow">if</span> hint == QAbstractItemView.EnsureVisible:
<a name="l00126"></a>00126                         rect = self.visualRect(index)
<a name="l00127"></a>00127                         <span class="keywordflow">if</span> rect.y() + rect.height() &gt; abs(self.viewport().y()) + self.height():
<a name="l00128"></a>00128                                 <span class="comment"># Position at bottom    </span>
<a name="l00129"></a>00129                                 rect = self.visualRect(index)
<a name="l00130"></a>00130                                 pos = rect.y() + rect.height() - self.height() 
<a name="l00131"></a>00131                                 pos = max( pos, 0 )
<a name="l00132"></a>00132                         <span class="keywordflow">elif</span> rect.y() &lt; abs(self.viewport().y()):
<a name="l00133"></a>00133                                 <span class="comment"># Position at top</span>
<a name="l00134"></a>00134                                 pos = self.visualRect(index).y()
<a name="l00135"></a>00135                 <span class="keywordflow">elif</span> hint == QAbstractItemView.PositionAtTop:
<a name="l00136"></a>00136                         pos = self.visualRect(index).y()
<a name="l00137"></a>00137                 <span class="keywordflow">elif</span> hint == QAbstractItemView.PositionAtBottom:
<a name="l00138"></a>00138                         rect = self.visualRect(index)
<a name="l00139"></a>00139                         pos = rect.y() + rect.height() - self.height() 
<a name="l00140"></a>00140                         pos = max( pos, 0 )
<a name="l00141"></a>00141                 <span class="keywordflow">elif</span> hint == QAbstractItemView.PositionAtCenter:
<a name="l00142"></a>00142                         rect = self.visualRect(index)
<a name="l00143"></a>00143                         pos = rect.y() + (rect.height()/2) - ( self.height()/2 )
<a name="l00144"></a>00144                         pos = max( pos, 0 )
<a name="l00145"></a>00145 
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> pos != <span class="keywordtype">None</span>:
<a name="l00147"></a>00147                         self.viewport().move( 0, - pos )
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="keyword">def </span>visualRect( self, index ):
<a name="l00150"></a>00150                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00151"></a>00151                         <span class="keywordflow">if</span> x.index == index:
<a name="l00152"></a>00152                                 <span class="keywordflow">return</span> x.geometry()
<a name="l00153"></a>00153                 <span class="keywordflow">return</span> QRect()
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <span class="keyword">def </span>isIndexHidden( self, index ):
<a name="l00156"></a>00156                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00157"></a>00157                         <span class="keywordflow">if</span> x.index == index:
<a name="l00158"></a>00158                                 <span class="keywordflow">if</span> x.geometry().y() &gt; self.viewport().y() + self.viewport().height() <span class="keywordflow">or</span> \
<a name="l00159"></a>00159                                         x.geometry().y + x.geometry().height() &lt; self.viewport().y():
<a name="l00160"></a>00160                                         <span class="keywordflow">return</span> <span class="keyword">True</span>
<a name="l00161"></a>00161                                 <span class="keywordflow">else</span>:
<a name="l00162"></a>00162                                         <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00163"></a>00163                 <span class="keywordflow">return</span> <span class="keyword">False</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="keyword">def </span>horizontalOffset(self):
<a name="l00166"></a>00166                 <span class="keywordflow">return</span> 0
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         <span class="keyword">def </span>verticalOffset(self):
<a name="l00169"></a>00169                 <span class="keywordflow">return</span> self.viewport().y()
<a name="l00170"></a>00170 
<a name="l00171"></a>00171         <span class="keyword">def </span>moveCursor( self, action, modifiers ):
<a name="l00172"></a>00172                 <span class="keywordflow">if</span> len(self.items) == 0:
<a name="l00173"></a>00173                         <span class="keywordflow">return</span> QModelIndex()
<a name="l00174"></a>00174                 <span class="keywordflow">if</span> action == QAbstractItemView.MoveUp:
<a name="l00175"></a>00175                         selected = self.selected - 1
<a name="l00176"></a>00176                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveDown:
<a name="l00177"></a>00177                         selected = self.selected + 1
<a name="l00178"></a>00178                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveHome:
<a name="l00179"></a>00179                         selected = 0
<a name="l00180"></a>00180                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveEnd:
<a name="l00181"></a>00181                         selected = len(self.items) - 1
<a name="l00182"></a>00182                 <span class="keywordflow">elif</span> action == QAbstractItemView.MovePageUp:
<a name="l00183"></a>00183                         selected = self.selected - 3
<a name="l00184"></a>00184                 <span class="keywordflow">elif</span> action == QAbstractItemView.MovePageDown:
<a name="l00185"></a>00185                         selected = self.selected + 3
<a name="l00186"></a>00186                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveNext:
<a name="l00187"></a>00187                         selected = self.selected + 1
<a name="l00188"></a>00188                 <span class="keywordflow">elif</span> action == QAbstractItemView.MovePrevious:
<a name="l00189"></a>00189                         selected = self.selected - 1
<a name="l00190"></a>00190                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveRight:
<a name="l00191"></a>00191                         selected = self.selected + 1
<a name="l00192"></a>00192                 <span class="keywordflow">elif</span> action == QAbstractItemView.MoveLeft:
<a name="l00193"></a>00193                         selected = self.selected - 1
<a name="l00194"></a>00194 
<a name="l00195"></a>00195                 selected = min(selected, len(self.items)-1)
<a name="l00196"></a>00196                 selected = max(selected, 0)
<a name="l00197"></a>00197                 <span class="keywordflow">if</span> selected != self.selected:
<a name="l00198"></a>00198                         self.selected = selected
<a name="l00199"></a>00199                         self.highlightSelected()
<a name="l00200"></a>00200                 <span class="keywordflow">return</span> self.items[self.selected].index
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         <span class="keyword">def </span>setSelection( self, rect, flags ):
<a name="l00203"></a>00203                 self.selected = -1
<a name="l00204"></a>00204                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> range(len(self.items)):
<a name="l00205"></a>00205                         <span class="keywordflow">if</span> self.items[x].geometry().intersects( rect ):
<a name="l00206"></a>00206                                 self.selected = x
<a name="l00207"></a>00207                 <span class="keywordflow">if</span> self.selected != -1:
<a name="l00208"></a>00208                         self.selectionModel().select( self.items[self.selected].index, QItemSelectionModel.Current )
<a name="l00209"></a>00209                 <span class="keywordflow">else</span>:
<a name="l00210"></a>00210                         self.selectionModel().select( QModelIndex(), QItemSelectionModel.Current )
<a name="l00211"></a>00211                 self.highlightSelected()
<a name="l00212"></a>00212 
<a name="l00213"></a>00213         <span class="keyword">def </span>visualRegionForSelection( self, selection ):
<a name="l00214"></a>00214                 region = QRegion()
<a name="l00215"></a>00215                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00216"></a>00216                         <span class="keywordflow">for</span> y <span class="keywordflow">in</span> selection.indexes():
<a name="l00217"></a>00217                                 <span class="keywordflow">if</span> x.index == y:
<a name="l00218"></a>00218                                         region.unite( QRegion( x.geometry() ) )
<a name="l00219"></a>00219                 <span class="keywordflow">return</span> region
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keyword">def </span>rowsInserted( self, index, start, end ):
<a name="l00222"></a>00222                 <span class="keywordflow">for</span> y <span class="keywordflow">in</span> range(start, end+1):
<a name="l00223"></a>00223                         item = self.createItemWidget( self.viewport() )
<a name="l00224"></a>00224                         item.index = self.model().index( y, 0, index )
<a name="l00225"></a>00225                         <span class="comment"># Fill in the item</span>
<a name="l00226"></a>00226                         <span class="keywordflow">if</span> self.map:
<a name="l00227"></a>00227                                 <span class="comment"># If there is a map, it means that autofilling is enabled</span>
<a name="l00228"></a>00228                                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.map:
<a name="l00229"></a>00229                                         idx = self.model().index( y, x[1], index )
<a name="l00230"></a>00230                                         exec(<span class="stringliteral">"item.%s.setText( self.model().data( idx ).toString() )"</span> % x[0] )
<a name="l00231"></a>00231                         <span class="keywordflow">else</span>:
<a name="l00232"></a>00232                                 <span class="comment"># Otherwise let the user fill in the item</span>
<a name="l00233"></a>00233                                 self.fillItemWidget( item )
<a name="l00234"></a>00234                         self.items.append(item)
<a name="l00235"></a>00235                         self.viewport().layout().addWidget( item )
<a name="l00236"></a>00236                         self.updateViewport( item.height() )
<a name="l00237"></a>00237 
<a name="l00238"></a>00238                 <span class="keywordflow">if</span> self.selected == -1:
<a name="l00239"></a>00239                         self.selected = 0
<a name="l00240"></a>00240                         self.highlightSelected() 
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         <span class="keyword">def </span>updateViewport(self, itemHeight):
<a name="l00243"></a>00243                 height = 0
<a name="l00244"></a>00244                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00245"></a>00245                         height += x.geometry().height()
<a name="l00246"></a>00246                 self.viewport().setFixedHeight( height )
<a name="l00247"></a>00247                 diff = self.viewport().height() - self.height()
<a name="l00248"></a>00248                 <span class="keywordflow">if</span> diff &lt; 0:
<a name="l00249"></a>00249                         diff = 0
<a name="l00250"></a>00250                 self.verticalScrollBar().setRange( 0, diff )
<a name="l00251"></a>00251                 self.verticalScrollBar().setValue( 0 )
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="keyword">def </span>rowsAboutToBeRemoved( self, index, start, end ):
<a name="l00254"></a>00254                 s = self.model().index( start, 0, index )
<a name="l00255"></a>00255                 e = self.model().index( end, 0, index )
<a name="l00256"></a>00256                 remove = []
<a name="l00257"></a>00257                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> self.items:
<a name="l00258"></a>00258                         <span class="keywordflow">if</span> ( s &lt; x.index <span class="keywordflow">or</span> s == x.index ) <span class="keywordflow">and</span> (x.index &lt; e <span class="keywordflow">or</span> x.index == e):
<a name="l00259"></a>00259                                 remove.append( x )
<a name="l00260"></a>00260                                 x.deleteLater()
<a name="l00261"></a>00261                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> remove:
<a name="l00262"></a>00262                         del self.items[self.items.index(x)]
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> self.selected &gt;= len(self.items):
<a name="l00264"></a>00264                         self.selected = -1
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keyword">def </span>highlightSelected(self):
<a name="l00267"></a>00267                 <span class="keywordflow">if</span> self.selected &lt; 0:
<a name="l00268"></a>00268                         <span class="keywordflow">return</span>
<a name="l00269"></a>00269                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> range(len(self.items)):
<a name="l00270"></a>00270                         <span class="keywordflow">if</span> x == self.selected:
<a name="l00271"></a>00271                                 self.items[x].setStyleSheet( <span class="stringliteral">'QWidget{background: yellow}'</span> )    
<a name="l00272"></a>00272                         <span class="keywordflow">else</span>:
<a name="l00273"></a>00273                                 self.items[x].setStyleSheet( <span class="stringliteral">''</span> )
<a name="l00274"></a>00274 
<a name="l00275"></a>00275 (FullTextSearchDialogUi, FullTextSearchDialogBase) = loadUiType( Common.uiPath(<span class="stringliteral">'full_text_search.ui'</span>) )
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">## @brief The FullTextSearchDialog class shows a dialog for searching text at all indexed models.</span>
<a name="l00278"></a>00278 <span class="comment">#</span>
<a name="l00279"></a>00279 <span class="comment"># The dialog has a text box for the user input and a combo box to search at one specific</span>
<a name="l00280"></a>00280 <span class="comment"># model or all models that have at least one field indexed.</span>
<a name="l00281"></a><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html">00281</a> <span class="keyword">class </span><a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html" title="The FullTextSearchDialog class shows a dialog for searching text at all indexed models...">FullTextSearchDialog</a>( QDialog, FullTextSearchDialogUi ):
<a name="l00282"></a>00282         <span class="keyword">def </span>__init__(self, parent = None):
<a name="l00283"></a>00283                 QDialog.__init__( self, parent )
<a name="l00284"></a>00284                 FullTextSearchDialogUi.__init__( self )
<a name="l00285"></a>00285                 self.setupUi( self )
<a name="l00286"></a>00286                 
<a name="l00287"></a>00287                 self.setModal( <span class="keyword">True</span> )
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#00396428998f60aeaa4d11fdcc9abec8">result</a>=<span class="keywordtype">None</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#9af2a92cd2b23fd11ba128ac5ff8244e">model</a> = FullTextSearchModel(self)
<a name="l00292"></a>00292                 <span class="comment">#self.uiItems = SearchView( self )</span>
<a name="l00293"></a>00293                 map = [ (<span class="stringliteral">'uiModel'</span>, 3), (<span class="stringliteral">'uiName'</span>, 4), (<span class="stringliteral">'uiHeadline'</span>, 5),
<a name="l00294"></a>00294                         (<span class="stringliteral">'uiRanking'</span>, 6) ]
<a name="l00295"></a>00295                 self.uiItems.setModelItemMap( map )
<a name="l00296"></a>00296                 self.uiItems.setItemUi( Common.uiPath(<span class="stringliteral">'searchviewitem.ui'</span>) )
<a name="l00297"></a>00297                 self.uiItems.setModel( self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#9af2a92cd2b23fd11ba128ac5ff8244e">model</a> )
<a name="l00298"></a>00298                 self.layout().insertWidget( 1, self.uiItems )
<a name="l00299"></a>00299 
<a name="l00300"></a>00300                 self.uiErrorMessage.hide()
<a name="l00301"></a>00301                 <span class="keywordflow">try</span>:
<a name="l00302"></a>00302                         answer = Rpc.session.call(<span class="stringliteral">'/fulltextsearch'</span>, <span class="stringliteral">'indexedModels'</span>, Rpc.session.context )
<a name="l00303"></a>00303                         self.uiModel.addItem( _(<span class="stringliteral">'(Everywhere)'</span>), QVariant( <span class="keyword">False</span> ) )    
<a name="l00304"></a>00304                         <span class="keywordflow">for</span> x <span class="keywordflow">in</span> answer:
<a name="l00305"></a>00305                                 self.uiModel.addItem( x[<span class="stringliteral">'name'</span>], QVariant( x[<span class="stringliteral">'id'</span>] ) )
<a name="l00306"></a>00306                         <span class="keywordflow">if</span> len(answer) == 0:
<a name="l00307"></a>00307                                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#10fe5dcec5033917a6915d70e5f2a718">disableQueries</a>( _(<span class="stringliteral">'&lt;b&gt;Full text search is not configured.&lt;/b&gt;&lt;br/&gt;Go to &lt;i&gt;Administration - Configuration - Full Text Search - Indexes&lt;/i&gt;. Then add the fields you want to be indexed and finally use &lt;i&gt;Update Full Text Search&lt;/i&gt;.'</span>) )
<a name="l00308"></a>00308                 <span class="keywordflow">except</span>:
<a name="l00309"></a>00309                         self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#10fe5dcec5033917a6915d70e5f2a718">disableQueries</a>( _(<span class="stringliteral">'&lt;b&gt;Full text search module not installed.&lt;/b&gt;&lt;br/&gt;Go to &lt;i&gt;Administration - Modules administration - Uninstalled Modules&lt;/i&gt; and add the &lt;i&gt;full_text_search&lt;/i&gt; module.'</span>) )
<a name="l00310"></a>00310 
<a name="l00311"></a>00311                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#bbf8834953ab91bac3f538bd9aae940b">title</a> = _(<span class="stringliteral">'Full Text Search'</span>)
<a name="l00312"></a>00312                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#17c4209bccabaf8ff19040abac555664">title_results</a> = _(<span class="stringliteral">'Full Text Search (%%d result(s))'</span>)
<a name="l00313"></a>00313 
<a name="l00314"></a>00314                 self.setWindowTitle( self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#bbf8834953ab91bac3f538bd9aae940b">title</a> )
<a name="l00315"></a>00315 
<a name="l00316"></a>00316                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c8c97c398dbdb5e8fc44622b63d20d4b">limit</a> = 10 
<a name="l00317"></a>00317                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> = 0
<a name="l00318"></a>00318                 self.pushNext.setEnabled( <span class="keyword">False</span> )
<a name="l00319"></a>00319                 self.pushPrevious.setEnabled( <span class="keyword">False</span> )
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                 self.connect( self.pushAccept, SIGNAL( <span class="stringliteral">"clicked( )"</span>), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#00e4a9dafd2aac82f9b97fb62106221a">open</a> )
<a name="l00322"></a>00322                 self.connect( self.uiItems, SIGNAL( <span class="stringliteral">"doubleClicked(QModelIndex)"</span>), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#00e4a9dafd2aac82f9b97fb62106221a">open</a> )
<a name="l00323"></a>00323                 self.connect( self.pushCancel , SIGNAL( <span class="stringliteral">"clicked()"</span>), self.reject )
<a name="l00324"></a>00324                 self.connect( self.pushFind, SIGNAL( <span class="stringliteral">"clicked()"</span>), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#57d37a3713044cdebf97f4878ab26443">find</a> )
<a name="l00325"></a>00325                 self.connect( self.pushPrevious, SIGNAL( <span class="stringliteral">"clicked()"</span> ), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#1b6e57573d3f3ce2ea7cc1d77495d5e8">previous</a> )
<a name="l00326"></a>00326                 self.connect( self.pushNext, SIGNAL( <span class="stringliteral">"clicked()"</span> ), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#0123b11388ea5f647afa72fe6012c872">next</a> )
<a name="l00327"></a>00327                 self.show()
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="keyword">def </span>disableQueries(self, text):
<a name="l00330"></a>00330                 self.uiModel.setEnabled( <span class="keyword">False</span> )
<a name="l00331"></a>00331                 self.pushFind.setEnabled( <span class="keyword">False</span> )
<a name="l00332"></a>00332                 self.pushAccept.setEnabled( <span class="keyword">False</span> )
<a name="l00333"></a>00333                 self.uiText.setEnabled( <span class="keyword">False</span> )
<a name="l00334"></a>00334                 self.uiItems.hide()
<a name="l00335"></a>00335                 self.uiErrorMessage.setText( text )
<a name="l00336"></a>00336                 self.uiErrorMessage.show()
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="keyword">def </span>textToQuery(self):
<a name="l00339"></a>00339                 q = unicode( self.uiText.text() ).strip()
<a name="l00340"></a>00340                 <span class="keywordflow">while</span> q != q.replace( <span class="stringliteral">'  '</span>, <span class="stringliteral">' '</span> ):
<a name="l00341"></a>00341                         q = q.replace( <span class="stringliteral">'  '</span>, <span class="stringliteral">' '</span> )
<a name="l00342"></a>00342                 q = q.replace(<span class="stringliteral">' '</span>, <span class="stringliteral">'|'</span>)
<a name="l00343"></a>00343                 <span class="keywordflow">return</span> q
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <span class="keyword">def </span>query(self):
<a name="l00346"></a>00346                 <span class="keywordflow">if</span> self.uiModel.currentIndex() == 0:
<a name="l00347"></a>00347                         model = <span class="keyword">False</span>
<a name="l00348"></a>00348                 <span class="keywordflow">else</span>:
<a name="l00349"></a>00349                         model = unicode( self.uiModel.itemData( self.uiModel.currentIndex() ).toString() )
<a name="l00350"></a>00350                 answer = Rpc.session.execute(<span class="stringliteral">'/fulltextsearch'</span>, <span class="stringliteral">'search'</span>, self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#f719e147cf2500dd93fe487db012b84f">textToQuery</a>(), self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c8c97c398dbdb5e8fc44622b63d20d4b">limit</a>, self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> , model, Rpc.session.context)
<a name="l00351"></a>00351                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#9af2a92cd2b23fd11ba128ac5ff8244e">model</a>.setList( answer )
<a name="l00352"></a>00352                 <span class="keywordflow">if</span> len(answer) &lt; self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c8c97c398dbdb5e8fc44622b63d20d4b">limit</a>:
<a name="l00353"></a>00353                         self.pushNext.setEnabled( <span class="keyword">False</span> )
<a name="l00354"></a>00354                 <span class="keywordflow">else</span>:
<a name="l00355"></a>00355                         self.pushNext.setEnabled( <span class="keyword">True</span> )
<a name="l00356"></a>00356                 <span class="keywordflow">if</span> self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> == 0:
<a name="l00357"></a>00357                         self.pushPrevious.setEnabled( <span class="keyword">False</span> )
<a name="l00358"></a>00358                 <span class="keywordflow">else</span>:
<a name="l00359"></a>00359                         self.pushPrevious.setEnabled( <span class="keyword">True</span> )
<a name="l00360"></a>00360                 
<a name="l00361"></a>00361         <span class="keyword">def </span>previous(self):
<a name="l00362"></a>00362                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> = max(0, self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> - self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c8c97c398dbdb5e8fc44622b63d20d4b">limit</a> )
<a name="l00363"></a>00363                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c6752ff63fe5df13319deba6a63b3df3">query</a>()
<a name="l00364"></a>00364                 
<a name="l00365"></a>00365         <span class="keyword">def </span>next(self):
<a name="l00366"></a>00366                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> = self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> + self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c8c97c398dbdb5e8fc44622b63d20d4b">limit</a>
<a name="l00367"></a>00367                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c6752ff63fe5df13319deba6a63b3df3">query</a>()
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="keyword">def </span>find(self):
<a name="l00370"></a>00370                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#8f928552704c52c29cb669b580ac1d6d">offset</a> = 0
<a name="l00371"></a>00371                 self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#c6752ff63fe5df13319deba6a63b3df3">query</a>()
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="keyword">def </span>reload(self):
<a name="l00374"></a>00374                 self.view.widget.model().removeAll()
<a name="l00375"></a>00375                 model = self.view.widget.model()
<a name="l00376"></a>00376                 index1 =  model.index( 1,1 )
<a name="l00377"></a>00377                 selectionModel = QItemSelectionModel( model )
<a name="l00378"></a>00378                 selectionModel.select( index1 , QItemSelectionModel.Rows )
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="keyword">def </span>open( self ):
<a name="l00381"></a>00381                 idx = self.uiItems.selectionModel().currentIndex()
<a name="l00382"></a>00382                 <span class="keywordflow">if</span> idx.isValid():
<a name="l00383"></a>00383                         id = self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#9af2a92cd2b23fd11ba128ac5ff8244e">model</a>.item( idx.row(), 0 ).text()
<a name="l00384"></a>00384                         model = self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#9af2a92cd2b23fd11ba128ac5ff8244e">model</a>.item( idx.row(), 2 ).text()
<a name="l00385"></a>00385                         self.<a class="code" href="classKoo_1_1Dialogs_1_1FullTextSearchDialog_1_1FullTextSearchDialog.html#00396428998f60aeaa4d11fdcc9abec8">result</a> = ( int(str(id)), unicode(model) )
<a name="l00386"></a>00386                         self.accept()
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 <span class="keyword">class </span>FullTextSearchModel( QStandardItemModel ):
<a name="l00389"></a>00389         <span class="keyword">def </span>__init__(self, parent = None):
<a name="l00390"></a>00390                 QStandardItemModel.__init__(self, parent)
<a name="l00391"></a>00391                 self.rootItem = self.invisibleRootItem()
<a name="l00392"></a>00392                 self.setColumnCount( 7 )
<a name="l00393"></a>00393                 self.setHeaderData( 0, Qt.Horizontal, QVariant( _(<span class="stringliteral">"ID"</span>) ) )
<a name="l00394"></a>00394                 self.setHeaderData( 1, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Model ID"</span>) ) )
<a name="l00395"></a>00395                 self.setHeaderData( 2, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Model Name"</span>) ) )
<a name="l00396"></a>00396                 <span class="comment"># Model Description</span>
<a name="l00397"></a>00397                 self.setHeaderData( 3, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Type"</span>) ) )
<a name="l00398"></a>00398                 self.setHeaderData( 4, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Name"</span>) ) )
<a name="l00399"></a>00399                 self.setHeaderData( 5, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Text"</span>) ) )
<a name="l00400"></a>00400                 self.setHeaderData( 6, Qt.Horizontal, QVariant( _(<span class="stringliteral">"Ranking"</span>) ) )
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                 self.serverOrder = [<span class="stringliteral">'id'</span>, <span class="stringliteral">'model_id'</span>, <span class="stringliteral">'model_name'</span>, <span class="stringliteral">'model_label'</span>, <span class="stringliteral">'name'</span>, <span class="stringliteral">'headline'</span>, <span class="stringliteral">'ranking'</span>]
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <span class="keyword">def </span>setList(self, list):
<a name="l00405"></a>00405                 <span class="keywordflow">if</span> self.rowCount() &gt; 0:
<a name="l00406"></a>00406                         self.removeRows(0, self.rowCount())
<a name="l00407"></a>00407                 <span class="keywordflow">for</span> x <span class="keywordflow">in</span> list:
<a name="l00408"></a>00408                         l = []
<a name="l00409"></a>00409                         <span class="keywordflow">for</span> y <span class="keywordflow">in</span> self.serverOrder:
<a name="l00410"></a>00410                                 item = QStandardItem()
<a name="l00411"></a>00411                                 value = x[y]
<a name="l00412"></a>00412                                 <span class="keywordflow">if</span> isinstance( value, float ):
<a name="l00413"></a>00413                                         item.setText( Numeric.floatToText( value ) )
<a name="l00414"></a>00414                                 <span class="keywordflow">else</span>:   
<a name="l00415"></a>00415                                         <span class="comment"># If name (for example) is False we just want to print it as empty text</span>
<a name="l00416"></a>00416                                         <span class="comment"># not as 'False' string.</span>
<a name="l00417"></a>00417                                         item.setText( unicode( x[y] <span class="keywordflow">or</span> <span class="stringliteral">''</span> ) )
<a name="l00418"></a>00418                                 l.append( item )
<a name="l00419"></a>00419                         self.rootItem.appendRow( l )
<a name="l00420"></a>00420                 
<a name="l00421"></a>00421 <span class="comment"># vim:noexpandtab:</span>
</pre></div></div>
<address><small>Generated by <a target="_blank" href="http://www.doxygen.org/index.html">Doxygen</a></small></address>
</body>
</html>
